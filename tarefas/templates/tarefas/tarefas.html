{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Tarefas{% endblock %}

{% block content %}
<h1 class="mt-4" style="color: #ff6d00;">Tarefas</h1>
<hr style="border-color: #ff6d00;">

<div class="kanban-container d-flex">
    <div class="kanban-columns" style="width: 75%; display: flex;">
        <!-- Coluna A Fazer -->
        <div class="kanban-column" id="a-fazer" data-status="a_fazer" style="background-color: #d4edda; padding: 10px;">
            <h2>A Fazer</h2>
            <hr>
            {% for tarefa in tarefas_a_fazer %}
                <div class="kanban-item" data-id="{{ tarefa.id }}" draggable="true">
                    <h6 class="text-muted">{{ tarefa.cliente }}</h6>
                    <h4>{{ tarefa.descricao }}</h4>
                    <span class="badge {% if tarefa.prioridade == 'alta' %}bg-danger{% elif tarefa.prioridade == 'media' %}bg-warning{% else %}bg-success{% endif %}">
                        {{ tarefa.get_prioridade_display }}
                    </span>
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'editar_tarefa' tarefa.id %}" class="btn btn-sm btn-light">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="#" class="btn btn-sm btn-light ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal"
                           data-nome="{{ tarefa.descricao }}" data-id="{{ tarefa.id }}"
                           onclick="setDeleteData('{{ tarefa.descricao }}', '{{ tarefa.id }}')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
            {% empty %}
                <p>Nenhuma tarefa a fazer.</p>
            {% endfor %}
        </div>

        <!-- Coluna Em Progresso -->
        <div class="kanban-column" id="em-progresso" data-status="em_progresso" style="background-color: #ffecb5; padding: 10px;">
            <h2>Em Progresso</h2>
            <hr>
            {% for tarefa in tarefas_em_progresso %}
                <div class="kanban-item" data-id="{{ tarefa.id }}" draggable="true">
                    <h6 class="text-muted">{{ tarefa.cliente }}</h6>
                    <h4>{{ tarefa.descricao }}</h4>
                    <span class="badge {% if tarefa.prioridade == 'alta' %}bg-danger{% elif tarefa.prioridade == 'media' %}bg-warning{% else %}bg-success{% endif %}">
                        {{ tarefa.get_prioridade_display }}
                    </span>
                    <div class="d-flex justify-content-end">
                        <a href="{% url 'editar_tarefa' tarefa.id %}" class="btn btn-sm btn-light">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="#" class="btn btn-sm btn-light ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal"
                           data-nome="{{ tarefa.descricao }}" data-id="{{ tarefa.id }}"
                           onclick="setDeleteData('{{ tarefa.descricao }}', '{{ tarefa.id }}')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </div>
            {% empty %}
                <p>Nenhuma tarefa em progresso.</p>
            {% endfor %}
        </div>
    </div>

    <div class="divider" style="width: 1px; background-color: #ff6d00;"></div>

    <!-- Coluna Concluídas -->
    <div class="kanban-column" id="concluidas" data-status="concluido" style="width: 25%; background-color: #cce5ff; padding: 10px; margin-left: 10px;">
        <h2>Concluídas</h2>
        <hr>
        {% for tarefa in tarefas_concluidas %}
            <div class="kanban-item" data-id="{{ tarefa.id }}" draggable="true">
                <h6 class="text-muted">{{ tarefa.cliente }}</h6>
                <h4>{{ tarefa.descricao }}</h4>
                <span class="badge {% if tarefa.prioridade == 'alta' %}bg-danger{% elif tarefa.prioridade == 'media' %}bg-warning{% else %}bg-success{% endif %}">
                    {{ tarefa.get_prioridade_display }}
                </span>
                <div class="d-flex justify-content-end">
                    <a href="{% url 'editar_tarefa' tarefa.id %}" class="btn btn-sm btn-light">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="#" class="btn btn-sm btn-light ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal"
                       data-nome="{{ tarefa.descricao }}" data-id="{{ tarefa.id }}"
                       onclick="setDeleteData('{{ tarefa.descricao }}', '{{ tarefa.id }}')">
                            <i class="bi bi-trash"></i>
                    </a>
                </div>
            </div>
        {% empty %}
            <p>Nenhuma tarefa concluída.</p>
        {% endfor %}
    </div>
</div>

<!-- Modal de confirmação de eliminação -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Você tem certeza que deseja excluir a tarefa "<span id="tarefaNome"></span>"?
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="tarefa_id" name="tarefa_id">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-container {
        display: flex;
    }
    .kanban-columns {
        display: flex;
        width: 75%;
    }
    .kanban-column {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-right: 10px;
        min-height: 100px;
    }
    .kanban-item {
        background: #ffffff;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
        padding: 10px;
        cursor: grab;
    }
    .kanban-item:active {
        cursor: grabbing;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

// Função para obter o CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializa o SortableJS para cada coluna
document.addEventListener('DOMContentLoaded', function() {
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(column => {
        new Sortable(column, {
            group: 'kanban',
            animation: 150,
            onEnd: function (evt) {
                const tarefaId = evt.item.dataset.id;
                const novoEstado = evt.to.dataset.status;
                console.log('Movendo tarefa:', tarefaId, 'para estado:', novoEstado); // Debug log
                atualizarEstadoTarefa(tarefaId, novoEstado);
            }
        });
    });
});

// Função para atualizar o estado da tarefa
async function atualizarEstadoTarefa(tarefaId, novoEstado) {
    try {
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken); // Debug log
        
        const response = await fetch('/tarefas/update-task-status/', { // Ajuste a URL conforme necessário
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                task_id: tarefaId,
                new_status: novoEstado
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao atualizar o estado da tarefa');
        }

        const data = await response.json();
        console.log('Resposta do servidor:', data);
    } catch (error) {
        console.error('Erro completo:', error);
        alert('Erro ao atualizar o estado da tarefa. Por favor, tente novamente.');
    }
}

// Função para configurar os dados da tarefa a ser eliminada
function setDeleteData(nome, id) {
    document.getElementById('tarefaNome').textContent = nome;
    document.getElementById('tarefa_id').value = id;
    document.getElementById('deleteForm').action = `/tarefas/apagar/${id}/`;
}
</script>
{% endblock %}